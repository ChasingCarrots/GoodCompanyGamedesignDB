{% extends 'helpers/base.html' %}

{% block content %}

<div id="moduleview" style="position: absolute; background-color: #eee; top: 70px; left: 50px; width: 300px; height: 400px;">
    <p id="moduledetails"></p>
    <p id="modulefeatures"></p>
    &nbsp;&nbsp;&nbsp; <button onclick="rotate_preview()">Rotate</button>
    &nbsp;&nbsp;&nbsp; <button onclick="view_module(0, 0)">Deselect</button>
    &nbsp;&nbsp;&nbsp; <button onclick="view_module(0, -1)">Delete Mode</button>
    <div id="modulegrid" style="position: absolute; top: 320px; left: 120px; right:160px; width:0px; height:0px;"></div>
</div>


<div id="modulelist" style="position: absolute; background-color: #eee; top: 500px; left: 50px;">
    <select id="modules" size="30" multiple style="width: 300px; height: 500px;">
        {% for module in moduleList %}
        <option value="{{module.id}}" onclick="view_module({{module.id}}, 0)">{{module.name}}</option>
        {% endfor %}
    </select>
</div>




<div id="interface" style="position: absolute; background-color: #eee; top: 70px; left: 400px; width: 600px; height: 50px;">
    <br>&nbsp;&nbsp;&nbsp;<select id="selected_product">
        {% for type in productTypes %}
        <option value="{{type.id}}">{{type.name}}</option>
        {% endfor %}
    </select>
    &nbsp;&nbsp;&nbsp;<button onclick="generate_grid()">Generate Grid</button>
</div>


<div id="builderview" style="position: absolute; background-color: #eee; top: 150px; left: 400px; width: 600px; height: 600px;"></div>


<div id="log" style="position: absolute; background-color: #eee; top: 800px; left: 400px; width: 600px; height: 200px;"></div>



<div id="faeture_overview" style="position: absolute; background-color: #eee; top: 70px; left: 1050px; width: 300px; height: 500px;">
</div>

{% endblock %}

{% block customjavascript %}
    <script>
        var options = [];
        options[0] = 0;
        options[1] = 0;
        options[2] = 0;


        var active_modules = [];
        active_modules[0] = 0
        var fields = [];

         var products = []
         {% for type in productTypes %}
            products[{{type.id}}] = []
            {% for field in type.fields %}
                products[{{type.id}}].push([{{field.x}}, {{field.y}}, 0])
            {% endfor %}
         {% endfor %}


        moduleList = []
         {% for module in moduleList %}
            moduleList[{{module.id}}] = []
            moduleList[{{module.id}}][0] = "{{module.name}}"
            moduleList[{{module.id}}][1] = "{{module.icon}}"
            moduleList[{{module.id}}][2] = []
            moduleList[{{module.id}}][3] = []
            {% for field in module.fields %}
                moduleList[{{module.id}}][2].push([{{field.x}}, {{field.y}}])
            {% endfor %}
            {% for feature in module.features %}
                moduleList[{{module.id}}][3].push([{{feature.feature.id}}, {{feature.value}}])
            {% endfor %}
         {% endfor %}

        featureList = []
         {% for feature in featureList %}
            featureList[{{feature.id}}] = []
            featureList[{{feature.id}}][0] = "{{feature.name}}"
            featureList[{{feature.id}}][1] = "{{feature.symbol}}"
            featureList[{{feature.id}}][2] = {{feature.type}}
            featureList[{{feature.id}}][3] = 0
         {% endfor %}

        function update_feature_overview() {
            s = ""
            featureList.forEach(function(item, index, array) {
                item[3] = 0
            });

            active_modules.forEach(function(module, mindex, array) {
                if (module != 0) {
                    moduleList[module][3].forEach(function(feature, findex, array) {
                        featureList[feature[0]][3] += feature[1]
                    });
                }
            });

            featureList.forEach(function(item, index, array) {
                if (item[3] != 0) {
                    s += item[1]+" - "+item[0]+": "+item[3]+"<br>"
                }
            });

            document.getElementById("faeture_overview").innerHTML = s;
        }

        function view_module(moduleID, activeID) {
            options[1] = moduleID;
            options[2] = activeID;
            if (moduleID == 0) {
                document.getElementById("moduledetails").innerHTML = "";
                document.getElementById("modulefeatures").innerHTML = "";
                document.getElementById("modulegrid").innerHTML = "";
                if (activeID == -1) {
                    document.getElementById("moduledetails").innerHTML = "IN DELETE MODE!";
                }
                return
            }

            s = ""
            if (activeID == 0) { s += "PLACEMENT MODE! <br>"; }
            if (activeID > 0) { s += "VIEW MODE! <br>"; }
            s += "<img height='20' src='/goodcompany/static/img/"+moduleList[moduleID][1]+".png'>   "
            s += " Name: "+moduleList[moduleID][0]
            document.getElementById("moduledetails").innerHTML = s;

            s = ""
            moduleList[moduleID][3].forEach(function(item, index, array) {
                s += ""+featureList[item[0]][1] + featureList[item[0]][0] + ": " +item[1]+"</br>"
            });
            document.getElementById("modulefeatures").innerHTML = s;


            size = 40
            s = ""
            moduleList[moduleID][2].forEach(function(item, index, array) {
                px = item[0]
                py = item[1]
                if (options[0] == 1) {
                    px = item[1]
                    py = -item[0]
                } else if (options[0] == 2) {
                    px = -item[0]
                    py = -item[1]
                } else if (options[0] == 3) {
                    px = -item[1]
                    py = item[0]
                }

                s += "<div style='background-color: #ccc; position: absolute;"
                s += "vertical-align: middle; text-align: center; line-height: "+(size)+"px;"
                s += "width:"+size+"px; height:"+size+"px;"
                s += "left:"+(px*size)+"px; bottom:"+(py*size)+"px;'"
                if (index == 0) {
                s += "><img height='30' src='/goodcompany/static/img/"+moduleList[moduleID][1]+".png' style='margin-top: 5px'></div>"
                } else {
                s += "></div>"
                }
            });
            document.getElementById("modulegrid").innerHTML = s;
        }

        function rotate_preview() {
            options[0] += 1
            if (options[0] >= 4) {
                options[0] = 0
            }
            view_module(options[1], options[2])
        }

        function generate_grid() {
            size = 60
            s = ""
            var selection = document.getElementById("selected_product");
            fields = []
            active_modules = [];
            active_modules[0] = 0
            products[selection.options[selection.selectedIndex].value].forEach(function(item, index, array) {
                s += "<div style='background-color: #ccc; position: absolute;"
                s += "vertical-align: middle; text-align: center; line-height: "+(size)+"px;"
                s += "width:"+size+"px; height:"+size+"px;"
                s += "left:"+(item[0]*size)+"px; bottom:"+(item[1]*size)+"px;'"
                s += "onclick='on_grid_click("+item[0]+", "+item[1]+")'"
                s += "id='gridfield_"+item[0]+"_"+item[1]+"'"
                s += "></div>"
                if (typeof fields[item[0]] == 'undefined') {
                    fields[item[0]] = [];
                }
                if (typeof fields[item[0]][item[1]] == 'undefined') {
                    fields[item[0]][item[1]] = [];
                }
                fields[item[0]][item[1]] = 0;
            });
            document.getElementById("builderview").innerHTML = s;
        }


        function on_grid_click(x, y) {
            if (typeof fields[x][y] == 'undefined') {
                return;
            }

            document.getElementById("log").innerHTML = ""

            if (options[2] == -1) {
                delete_module(fields[x][y])
                update_feature_overview()

            } else if (options[1] != 0 && options[2] == 0) {
                if (check_spaces(x, y, 0) == 1) {
                    active_modules.push(options[1])
                    id = active_modules.length - 1
                    set_fields(x, y, id)
                    update_feature_overview()
                }

            } else if (options[1] == 0 && options[2] >= 0) {
                view_module(active_modules[fields[x][y]], fields[x][y])
            } else if (options[2] > 0) {
                view_module(active_modules[fields[x][y]], fields[x][y])
            }
        }

        function delete_module(id) {
            active_modules[id] = 0
            fields.forEach(function(row, rindex, fields) {
                fields.forEach(function(field, index, rows) {
                    if (typeof fields[rindex][index] !== 'undefined') {
                    if (fields[rindex][index] == id) {
                        element = document.getElementById("gridfield_"+(rindex)+"_"+(index))
                        element.innerHTML = ""
                        element.style.backgroundColor = "#ccc"
                        fields[rindex][index] = 0
                    }
                    }
                });
            });
        }

        function set_fields(x, y, module) {
            var min=0;
            var max=255;
            var r =  Math.floor(Math.random() * (+max - +min)) + +min;
            var g =  Math.floor(Math.random() * (+max - +min)) + +min;
            var b =  Math.floor(Math.random() * (+max - +min)) + +min;
            color = "rgb("+r+", "+g+", "+b+")"


             bx = -moduleList[options[1]][2][0][0]
             by = -moduleList[options[1]][2][0][1]

            moduleList[options[1]][2].forEach(function(item, index, array) {
                px = item[0]
                py = item[1]
                if (options[0] == 1) {
                    px = item[1]
                    py = -item[0]
                } else if (options[0] == 2) {
                    px = -item[0]
                    py = -item[1]
                } else if (options[0] == 3) {
                    px = -item[1]
                    py = item[0]
                }
                if (typeof fields[x+px+bx][y+py+by] == 'undefined') {
                    end;
                }

                fields[x+px+bx][y+py+by] = module;

                element = document.getElementById("gridfield_"+(x+px+bx)+"_"+(y+py+by))
                element.style.backgroundColor = color
                if (index == 0) {
                    element.innerHTML = "<img height='50' src='/goodcompany/static/img/"+moduleList[options[1]][1]+".png' style='margin-top: 5px'>";
                }
            });
        }

        function check_spaces(x, y, exception) {
            value = 1
             bx = -moduleList[options[1]][2][0][0]
             by = -moduleList[options[1]][2][0][1]
            moduleList[options[1]][2].forEach(function(item, index, array) {
                px = item[0]
                py = item[1]
                if (options[0] == 1) {
                    px = item[1]
                    py = -item[0]
                } else if (options[0] == 2) {
                    px = -item[0]
                    py = -item[1]
                } else if (options[0] == 3) {
                    px = -item[1]
                    py = item[0]
                }
                if (typeof fields[x+px+bx] == 'undefined') {
                    value = 0
                } else if (typeof fields[x+px+bx][y+py+by] == 'undefined') {
                    value = 0
                } else if (fields[x+px+bx][y+py+by] != 0 && fields[x+px+bx][y+py+by] != exception) {
                    value = 0
                }
            });
            return value
        }
    </script>
{% endblock %}